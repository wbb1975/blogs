# OAuth 2 实现单点登录
单点登录是多域名企业站点流行的登录方式。本文以现实生活场景辅助理解，力争彻底理清 OAuth2.0 实现单点登录的原理流程。同时总结了权限控制的实现方案，及其在微服务架构中的应用。
## 1 什么是单点登录
### 1.1 多点登录
传统的多点登录系统中，每个站点都实现了本站专用的帐号数据库和登录模块。各站点的登录状态相互不认可，各站点需要逐一手工登录。如下图，有两个术语含义如下：
- 认证(authentication): 验证用户的身份；
- 授权(authorization): 验证用户的访问权限。

![多点登录](images/multi_sign_on.webp)
### 1.2 单点登录
单点登录，英文是 Single Sign On，缩写为 SSO。多个站点(192.168.1.20X)共用一台认证授权服务器(192.168.1.110，用户数据库和认证授权模块共用)。用户经由其中任何一个站点(比如 192.168.1.201)登录后，可以免登录访问其他所有站点。而且，各站点间可以通过该登录状态直接交互。

![单点登录](images/sso.webp)
## 2 OAuth2 认证授权的原理流程
### 2.1 生活实例
为了直观的理解 OAuth2.0 原理流程，我们假设这样一个生活场景：
- 档案局A(`客户端/Client`)：以“档案局ID/密码”标识，是掌握档案资源的机构。并列还有很多档案局B/C/…，每个档案局存储的档案内容(`资源/Resource`)不一样，比如政治、经济、军事、文化等；
- 公民张三(`资源所有者/Resource Owner`)：以“用户名/密码”标识，需要到各个档案局查档案
- 派出所(`授权服务器/Authentication Server`)：可以是单个巨大的派出所，也可以是数据共享的派出所集群，掌管的信息、提供的对外接口功能有：
  + 档案局信息：所有档案局的“档案局ID/密码”，证明档案局的身份；
  + 公民信息：所有公民的“用户名/密码”，能提供张三是张三的用户身份证明(`认证/Authentication`)
  + 公民对于档案局的权限：有张公民和档案局的权限的映射表，可查得各公民对各档案局是否有操作权限(`授权/Authorization`)。通常，设计中会增加官职(`角色/Role`)一层，各公民属于哪个官职(`角色`)，哪个官职(`角色`)对于特定档案局有操作权限。
#### 2.1.1 张三首次访问档案局A
#### 2.1.2 张三首次访问档案局B
#### 2.1.3 张三再次访问档案局A
### 2.2 HTTP 重定向原理
### 2.3 SSO 工作流程
### 2.4 OAuth2.0 进阶
## 3 基于 SpringBoot 实现认证/授权
### 3.1 授权服务器(Authorization Server)
### 3.2 客户端(Client, 业务网站)
### 3.3 用户权限控制(基于角色)
## 4 综合运用
### 4.1 权限控制方案
### 4.2 在微服务架构中的应用
### 

## Reference
- [OAuth 2 实现单点登录](https://mp.weixin.qq.com/s?__biz=MzI3ODcxMzQzMw==&mid=2247554905&idx=2&sn=4ecd9ec0837291e79a210f0ee4eb5ffb&chksm=eb50926fdc271b79a11bd1d73019471df64065ed3ffabdc3a966d82bab6c5a2c408669e46db5&scene=132#wechat_redirect)