# Docker架构引用：Docker日志设计与最佳实践
## 简介
传统上设计与实现集中式日志是一件事后工作。直到问题出现，一个可供查询，查看，分析日志的集中式日志方案才被提到一个高优先级，以此来帮助定位问题根源。当时，在容器化的时代，当利用Docker企业平台来设计一个“容器即服务”(CaaS)的平台时，集中式日志方案的优先级是至关重要的。随着在容器中部署的微服务日趋增多，由它们产生的日志（事件）格式数据数量呈指数级增长。
## 你将学到什么
这份架构引用提供了一份Docker日志如何工作的概观，解释了Docker日志的两种类别，然后讨论Docker日志最佳实践。
## 理解Docker日志（机制）
在深入讨论Docker日志设计考量之前，最好了解一些Docker日志的基础知识。

Docker支持不同的日志驱动用于存储或流化来自主容器进程（pid 1）的容器标准输出和错误输出。缺省地，Docker使用`json-file`日志驱动，但它可通过修改`/etc/docker/daemon.json`中`log-driver`的配置值来使用其它许多日志驱动，注意需要重启Docker服务以重新加载配置。

新的日志驱动将应用于重新配置（重新配置日志驱动后重启已存在的容器并不会导致容器使用更新后的设置）之后启动的所有容器。为了覆盖缺省日志驱动可以使用`--log-driver` 或 `--log-opt`选项启动容器。另一方面，Swarm-mode的服务可以在运行时使用`docker service update --log-driver <DRIVER_NAME> --log-opt <LIST OF OPTIONS> <SERVICE NAME>`动态修改其日志驱动。

那Docker引擎本身的日志呢？这些日志被系统缺省管理日志器（default system manager logger）处理。大部分现代操作系统 (CentOS 7, RHEL 7, Ubuntu 16等)使用systemd，它使用journald记录日志，journalctl来访问日志。可使用`journalctl -u docker.service`来访问驱动日志。
## Docker日志类别和源
现在我们已经讨论过Docker日志的基础知识，这一节将解释日志类别和日志源。

Docker日志典型地划分为两类：基础设施管理和应用日志。大多数日志基于访问它们的角色自然地进入以上两种类型：
+ 运维人员主要担心平台的稳定性和服务的可用性
+ 开发人员主要担心应用代码以及服务如何运行

为了拥有一个自服务平台（self-service platform），为了执行他们的角色的职责运维人员和开发人员都需要访问日志。DevOps实践建议两者应对服务的可用性及性能有综合的，共享的责任。但是，每人并不需要访问平台上的每个日志（类型）。比如，开发人员应该仅仅访问它们的服务，以及集成点的日志。运维人员更关心Docker服务日志，UCP与DTR可用性，以及服务可用性。因为运维人员和开发人员都关注服务可用性，他们的日志关注点可能有点重合。每个角色需要访问的日志允许当问题出现时问题定位更简单，平均解决时间（(MTTR)）不断下降。
### 基础设施管理日志
基础设施管理日志包括Docker引擎日志，运行UCP或DTR的容器日志，以及任何部署的集中式基础设施服务（考虑容器化的监控代理）。
#### Docker引擎日志
正如前面提到，Docker引擎日志由操作系统系统管理器捕获。这些日志可被发送到一个集中式日志服务。
#### UCP与DTR系统日志
UCP与DTR被部署为Docker容器。它们的日志在容器的标准输出与错误输出（`STDOUT/STDERR`）中被捕获。Docker引擎的缺省日志驱动捕获这些日志。

UCP可被配置为使用远程syslog日志设施 ，这可以在安装后从UCP UI上为其所有容器修改。
> **注意**：推荐在安装UCP与DTR之前配置Docker引擎缺省日志驱动，这样它们的日志可被选择的日志驱动捕获。这是由于容器一旦被创建，就不能够改变其日志驱动。这个规则的唯一例外是`ucp-agent`，它是UCP 的一个组件，被部署为一个Swarm服务。
#### 基础设施服务
基础设施运维团队部署集中式的基础设施服务用于各种各样的基础设施运维操作，例如监控，审计，报告，配置部署等等。这些服务也会产生重要日志，需要捕获。典型地，这些日志限于其容器的标准输出与错误输出，因此它们都会被Docker引擎的缺省日志驱动捕获。如果没有，它们就需要被单独处理。
### 应用日志
应用产生的日志可包括定制的应用日志以及应用主进程的`STDOUT/STDERR`日志。正如前面描述的，所有容器的`STDOUT/STDERR`日志被Docker引擎的缺省日志驱动捕获。因此，不需要去做任何定制配置来捕获它们。如果应用有定制的日志（比如将日志写入容器内的/var/log/myapp.log），你就必须考了你到这一点（如何捕获它们）。
## Docker日志设计考量
理解Docker引擎的类型是重要的。定义消费及拥有它们的入口也是很重要的。
### Docker日志类别
主要地，Docker日志分为两类：基础设施日志和应用日志。
### 定义组织所有权
根据组织结构和策略决定这些类别可否与现有团队有直接的映射。如果没有，定义这些组织或团队的对应日志类别是非常重要的。

类别|团队
--------|--------
系统和管理日志|基础设施运维
应用日志|应用维护

如果组织是大的组织的一部分，这些类型可能更多，可将它们细分到更特定的团队。

类别|团队
--------|--------
Docker引擎日志|基础设施运维
基础设施服务|基础设施运维
UCP与DTR日志|UCP与DTR维护
应用A日志|应用A维护
应用B日志|应用B维护

有些组织并不区分基础设施运维和应用维护，因此它们可能合并这两类并由一个运维团队负责拥有它们。

类别|团队
--------|--------
系统和管理日志|基础设施运维
应用日志|基础设施运维
### 选择一个日志基础设施
Docker可以很容易地与现有日志工具和方案集成。日志生态系统中的大部分日志工具已经开发了Docker日志，并提供了与Docker集成的合适的文档。

选取日志方案如下：
+ 允许上节定义的日志所有权模型实现。例如，某些组织可能选择发送所有日志到一个简单的日志基础设施，然后对不同运营团队提供不同的访问级别。
+ 组织最熟悉它。Docker能够与大多数流行的日志供应商集成。请参考你的日志供应商的文档以获取更多信息。
+ 拥有Docker集成：预配置的仪表板，稳定的Docker插件，合适的文档等。
### 应用日志驱动
Docker拥有几种可用的日志驱动可被用于应用程序日志的管理。检查[Docker docs](https://docs.docker.com/config/containers/logging/#supported-logging-drivers)可获取其完整列表以及如何使用它们的细节信息。许多日志供应商拥有收集和发送日志的代理，请参阅其正式文档以了解如何配置代理以便和Docker企业版集成。

一个通用规则，如果已经有一个到位的日志基础设施，你应该使用已有基础设施的日志驱动。下面是一个Docker企业版内建的日志引擎列表。

驱动|优点|缺点
--------|--------|--------


## 收集日志
## 部署日志代理
## Brownfield应用日志
## 日志基础设施
## 结论

## Reference
- [Docker Reference Architecture: Docker Logging Design and Best Practices](https://success.docker.com/article/logging-best-practices)