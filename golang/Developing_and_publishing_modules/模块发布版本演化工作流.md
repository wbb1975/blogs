# 模块发布版本演化工作流

当你开发由其他开发者使用的模块时，你可以遵守一个工作流，它可以帮助为模块使用者确保稳定一致的体验。这篇主题描述了这个工作流的高阶步骤。

关于模块开发的简介，参见[开发并发布模块](https://go.dev/doc/modules/developing)。

也可参见：

- 如果您仅仅想在你的代码中使用外部模块，可以参见[管理依赖](https://go.dev/doc/modules/managing-dependencies)
- 对每一个新的版本，你使用版本号为你的模块签名。更多信息，参见[模块版本演化](https://go.dev/doc/modules/version-numbers)。

## 1. 公共工作流步骤（Common workflow steps）

下面的序列演示了一个新的模块发行及版本演化工作流步骤。对每一步的更多细节，参见本文的小节。

1. **开始一个模块**，组织代码使其更易于使用且更易维护。

   如果你是首次开发模块，参考[教程：创建一个模块](https://go.dev/doc/tutorial/create-module)。

   在 Go 的去中心化模块发布系统，你如何组织你的代码很关键。请参见[管理模块代码](https://go.dev/doc/modules/managing-source)。

2. 设置环境，**编写本地客户端代码**来调用未发布模块里的函数。

   在你发布一个模块之前，典型的依赖管理工作流使用命令如 `go get` 是不可用的。这个阶段测试你的模块代码一个比较好的方式从模块代码所在本地目录编写客户端代码调用它。

   参见[针对未发布模块编程](https://go.dev/doc/modules/release-workflow#unpublished)以了解更多本地编程。

3. 当模块代码已经准备好给其他开发者试用时，**开始发布 `v0` 预发行版本**如 `alphas` 和 `betas`。参见[发布预发行版本](https://go.dev/doc/modules/release-workflow#pre-release) 以了解更多。

4. **发布一个 `v0` 版本**也不能保证这是一个稳定版本，但是用户可以尝试。更多信息，参见[发布第一个（不稳定版本）](https://go.dev/doc/modules/release-workflow#first-unstable)。
   
5. 在你的 `v0` 版本发布后，你可以（应该）继续**发布发布它的新版本**。

   这些新版本可能包括问题修正（补丁发布），新增模块公开 API（小发布），甚至不兼容发布。因为 v0 发布不保证稳定性和向后兼容性，你可以在其版本中引入不兼容修改。

   更多细节，参见[发布问题修正](https://go.dev/doc/modules/release-workflow#bug-fixes)，和[发布兼容修改](https://go.dev/doc/modules/release-workflow#non-breaking)。

6. 当你的稳定版本已经准备好发布时，**发布预发行版本如 `alpha`s 和 `betas`**。参见[发布预发行版本](https://go.dev/doc/modules/release-workflow#pre-release) 以了解更多。

7. 发布 `v1` 作为**第一个稳定版本**。

   这是第一个承诺保证稳定性的发布。更多细节，参见[发布第一个稳定版本](https://go.dev/doc/modules/release-workflow#first-stable)

8. 在 `v1` 版本中，**继续修订问题**，必要时为模块添加新的公开 API。

    更多细节，参见[发布问题修正](https://go.dev/doc/modules/release-workflow#bug-fixes)，和[发布兼容修改](https://go.dev/doc/modules/release-workflow#non-breaking)。

9. 当不可避免时，在一个**主要版本发布**不兼容修改。

   一个主要的版本修改 - 比如从 `v1.x.x` 到 `v2.x.x` - 对于你的用户可能是一个破坏性的升级，这应该是最后的手段。更多信息，参见[发布不兼容 API 修改](https://go.dev/doc/modules/release-workflow#breaking)。


## 2. 针对未发布模块编程（Coding against an unpublished module）

当你开始开发一个新的模块或者一个新版本的模块，你尚未发布它。在你发布一个模块之前，你不能使用 Go 命令来添加该模块作为依赖。作为替代，首先，当你在另一个模块编写代码调用未发布的模块中的函数时，你需要引用引用本地文件系统中该模块的一个拷贝。

你可以在客户端模块的 `go.mod` 文件中使用 `replace` 指令来引用一个模块。更过信息，请参见[需要本地目录中的模块代码](https://go.dev/doc/modules/managing-dependencies#local_directory)。

## 3. 发布预发行版本（Publishing pre-release versions）

你可以发布一个预发布版本以让他人尝试并提供反馈。一个预发布版本不保证稳定性。

预发布版本版本号添加有预发布标识符。关于版本数字的更多信息，请参见[模块版本数字](https://go.dev/doc/modules/version-numbers)。

这里有两个例子：

```
v0.2.1-beta.1
v1.2.3-alpha
```

当发布预发布版本时，记住预发布版本的开发者需要使用 `go get` 显式指定版本号。这是因为，默认情况下当定位你请求的模块时，go 偏爱发布版本而非预发布版本。因此，开发者必须通过显式指定来获得预发布版本，如下例所示：

```
go get example.com/theirmodule@v1.2.3-alpha
```

通过在你的代码仓库里为模块代码传递预发布版本标识打标签，你可以发布预发布版本。更多信息，参见[发布模块](https://go.dev/doc/modules/publishing)。

## 4. 发布第一个（不稳定版本）（Publishing the first (unstable) version）

当你发布一个预发布版本时，你可以发布一个不保证稳定性和后向兼容性的发布版本。从而给你的用户一个尝试模块的机会，并借此收集反馈。

不稳定版本是那些版本数字在 `v0.x.x` 范围的版本。`v0` 版本不保证稳定性和后向兼容性。但它给你一个确保 `v1` 及之后版本兼容性之前收集反馈和完善你的 API 的机会。更多信息，请参见[模块版本数字](https://go.dev/doc/modules/version-numbers)。

和其它发布版本一样，你可以增加 `v0` 版本号里的次版本及补丁版本部分，就像你对稳定的 `v1` 版本所做的那样。例如，发布 `v.0.0.0` 之后，你可以对其发布第一个补丁修正版本 `v0.0.1`。

下面是一个版本例子：

```
v0.1.3
```

通过在你的代码仓库里为模块代码打标签以发布不稳定版本，标签标识符如 `v0` 所示。更多信息，参见[发布模块](https://go.dev/doc/modules/publishing)。

## 5. 发布第一个稳定版本（Publishing the first stable version）

你的第一个稳定发布将会像 `v1.x.x` 版本号。第一个稳定版本通常在通过预发布版本，`v0` 版本收集到足够的反馈，问题修正，以及模块稳定之后发布。

通过 `v1` 发布，你向模块用户发出了如下承诺：

- 他们可以升级到该主版本之后的次版本及补丁版本而不用打破他们的代码
- 你不会对模块的公开 API 做进一步需改 -- 包括其功能及函数签名 -- 它将打破后向兼容性
- 你将不会移除任何导出类型，这也将打破后向兼容性
- 对你的 API 的进一步修改（例如对结构体增加新的字段）将保证后向兼容性并在一个新的次版本中发布
- 问题修正（例如一个安全补丁）将被包含在在一个补丁发布或者次版本发布中

> 注意：你的第一个主版本可能是 `v0` 版本，它不具任何稳定性及后向兼容性保证。结果就是，当你把 `v0` 增加到 `v1`，你不必介意打破后向兼容性，原因就在于 `v0` 并不认为是稳定的。

关于版本数字的更多信息，请参见[模块版本数字](https://go.dev/doc/modules/version-numbers)。

下面是一个稳定版本例子：

```
v1.0.0
```

通过在你的代码仓库里为模块代码打标签以发布稳定版本，标签标识符如 `v1` 所示。更多信息，参见[发布模块](https://go.dev/doc/modules/publishing)。

## 6. 发布问题修正版本（Publishing bug fixes）

你可以发布一版本其修改仅局限于问题修正。它又被称为补丁发布。

补丁发布仅包括小的修改。尤其注意，它不包括对模块公开 API 的修改。消费代码的开发者可以安全地升级到这个版本而不需要修改他们的代码。

> 注意：你的补丁发布不应该升级任何模块自身的传递依赖。否则，升级的模块补丁版本的用户将会由于无意中引入侵入式修稿而使事情变得糟糕。

补丁发布增加版本号里的补丁版本部分，关于版本数字的更多信息，请参见[模块版本数字](https://go.dev/doc/modules/version-numbers)。

在下面的例子在，`v1.0.1` 是补丁发布。

老版本: `v1.0.0`

新版本: `v1.0.1`

通过在你的代码仓库里为模块代码打标签以发布补丁版本，可以增加标签标识符中的补丁部分。更多信息，参见[发布模块](https://go.dev/doc/modules/publishing)。

## 7. 发布兼容 API 修改（Publishing non-breaking API changes）

你可以对你的模块公开 API 做兼容修改并通过一个次版本发布。

这个版本修改 API，但并不以一种破坏调用代码的方式。它可能包括对模块自身依赖的修改，或者增加新的函数，方法，结构体字段，或类型等。即使包括遮羞修改，它保证调用模块代码的兼容性和稳定性。

次版本发布增加版本号里的次版本部分，关于版本数字的更多信息，请参见[模块版本数字](https://go.dev/doc/modules/version-numbers)。

在下面的例子在，`v1.1.0` 是次版本发布。

老版本: `v1.0.1`

新版本: `v1.1.0`

通过在你的代码仓库里为模块代码打标签以发布次版本，可以增加标签标识符中的次版本部分。更多信息，参见[发布模块](https://go.dev/doc/modules/publishing)。

## 8. 发布不兼容 API 修改（Publishing breaking API changes）

你可以发布一个主版本以打破兼容性。

一个主版本不保证兼容性，典型地它包含模块公开 API 的修改，它通常会破坏使用模块之前版本的代码。

考虑到主版本升级所带来的对依赖模块的代码的破坏性的结果，如果可能你应该避免主版本升级。关于更过主版本升级的信息，请参考[开发主版本更新](https://go.dev/doc/modules/major-version)。关于避免破坏性修改的策略，请参见博文[保持你的模块兼容](https://blog.golang.org/module-compatibility)。

当发布其它种类的发布时主要需要给模块代码带上一个特定的版本标签，发布一个主版本更新需要更多步骤：

1. 在新的主版本开始开发前，在你的仓库里为新发布创建一个地方。

   实现这个的一种方式是在你的仓库中创建一个新的分支，特定地它是一个主版本，及其后的次版本及补丁版本。更多细节，请参考[管理模块源代码](https://go.dev/doc/modules/managing-source)。
2. 在模块的 go.mod 文件中，修改模块路径以附上新的模块号，如下所示：

   ```
   example.com/mymodule/v2
   ```

   假设模块路径即为模块标识符，这个修改实际上相当于创建了一个新的模块。它也改变了包的路径，确保开发者不会无意识地带入了一个破坏代码的版本。反之，那些等待升级的代码将会将旧路径替换为新路径。

3. 在你的代码中，在任何你导入更新模块的报的地方，修改包路径。你需要做这个原因在于你修改了模块路径。
4. 当有任何新的发布，你应该在正式发布前先发布与分布版本以收集反馈和问题报告。
5. 通过在你的代码仓库里为模块代码打标签以发布新的主版本，可以增加标签标识符中的主版本部分 -- 例如从 `v1.5.2` 到 `v2.0.0`。更多信息，参见[发布模块](https://go.dev/doc/modules/publishing)。

## Reference

- [模块发布版本演化工作流](https://go.dev/doc/modules/release-workflow)