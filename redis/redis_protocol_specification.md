# Redis协议规范
Redis客户端与Redis服务器通过一个叫做RESP (REdis Serialization Protocol)（Redis序列化协议）的协议通讯。虽然这个协议是为Redis特别设计的，它也可用于其它CS架构软件项目。

RESP是下列目标的妥协产物：
- 容易实现
- 快速解析
- 人可阅读

RESP可以序列化不同的数据类型如整型，字符串，数组等。还有一个特殊的类型用于表示错误。请求从客户端被发送到Redis服务端的，它以字符串数组的形式表示了执行的命令的参数。Redis回复的数据类型与命令相关。

RESP是二进制安全的，并不需要从一个进程到另一个进程的款数据传输的额外处理--它使用前缀长度来传输块数据。
> **注意**：这里简单描述的协议仅仅用于CS架构通讯。Redis集群用一种不同的二进制协议在节点间交换消息。
## 网络层
一个连接到Redis服务器的Redis客户端事实上创建了一个到端口6379的TCP连接。虽然RESP技术上是TCP无关的，在Redis的背景下该协议仅仅用于TCP连接（或同等面向流的连接，如Unix套接字）。
## 请求-回复模型（Request-Response model）
Redis接受由不同参数组成的命令。一旦一条命令被收到，它就会被处理并发回一条回复给客户。

这可能是最简单的模式，但有两个例外：
- Redis支持流水线（pipeline）（本文后面还会谈到）。因此客户可以一次发送多条命令，并随后等待回复。
- 当一个Redis客户订阅了一个Pub/Sub通道，协议将改变语义并变成一个推送（push）协议，即客户不再需要发送请求，因为只要有新消息到达，服务器会自动发送给它们（只有客户端订阅了的通道才会收到）。

排除上面两个意外，Redis协议是一个简单的请求-回复协议。
## RESP协议描述
RESP协议在Redis 1.2中引入，但是直到Redis 2.0它才变成与Redis服务器交谈的标准方式。这是在你的Redis客户端必须实现的协议。

RESP实际上是一个序列化协议，它支持以下数据类型：简单字符串，错误，整型，块字符串（Bulk Strings）和数组。

RESP在Redis中以下面的方式被用作请求-回复协议：
- 客户端以RESP 块字符串（Bulk Strings）数组的形式发送命令到Redis服务器
- 服务器根据命令的实现以一种RESP类型回复

在RESP中，一些数据的类型取决于第一个字节：
+ 对于简单字符串，回复的第一个字节是"+"
+ 对于错误，回复的第一个字节是"-"
+ 对于整数，回复的第一个字节是":"
+ 对于块字符串（ **Bulk Strings**），回复的第一个字节是"$"
+ 对于数组，回复的第一个字节是"*"

另外RESP可以用后面描述的块字符串或数组的一个特殊变体来表示一个空（Null）值。在RESP中协议的不同部分总是以"\r\n" (CRLF)终结。
## RESP简单字符串
简单字符串以下面的形式编码：一个"+"，后面跟随不包含CR 和 LF的字符串（换行符不被允许），以回车换行符终结（"\r\n"）。

简单字符串用于以最小负荷传送非二进制安全的字符串。例如许多Redis命令在成功时仅仅返回"OK"，它以RESP简单字符串的形式编码为如下5个字节：
```
+OK\r\n
```
为了发送二进制安全字符串，RESP块字符串可以代替。
当Redis回复一个简单字符串，客户端库应该向调用者返回一个字符串包含从 '+' 后的第一个字符直到简单字符串结尾（排除最后的CRLF）。
## RESP错误
RESP对错误有一个特殊的数据类型。实际上错误几乎和RESP简单字符串一样，除了第一个字符是减号'-' 而不是加号。RESP中简单字符串和错误的真正差别在于错误在客户端被当做异常处理，并且组成错误类型的字符串是错误消息本身。

基本的格式为：
```
"-Error message\r\n"
```
只有当某种异常发生时错误回复才会被发送，比如你在错误数据类型上执行操作，或者命令不存在，等等。当一个错误回复收到时客户端库应该抛出一个异常。

下面是错误回复示例：
```
-ERR unknown command 'foobar'
-WRONGTYPE Operation against a key holding the wrong kind of value
```

## Reference
- [Redis Protocol Specification](https://redis.io/topics/protocol)